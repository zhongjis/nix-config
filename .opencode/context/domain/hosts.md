# Host-Specific Patterns

Patterns and configurations for each host in the nix-config repository.

## Host Overview

| Host | OS | Architecture | Profile | Status |
|------|-----|--------------|---------|--------|
| **framework-16** | NixOS | x86_64-linux | Desktop + Gaming | Active |
| **Zs-MacBook-Pro** | macOS | aarch64-darwin | Full macOS | Active |
| **thinkpad-t480** | NixOS | x86_64-linux | (configured) | Inactive |

## framework-16 (NixOS)

### Hardware Configuration

```nix
# hosts/framework-16/hardware-configuration.nix
# Auto-generated by nixos-generate-config
# Key components:
# - CPU: AMD (Zen 4)
# - GPU: AMD Radeon 7700 (RDNA 3)
# - Storage: NVMe SSD
# - Memory: DDR5
# - Display: 16" 3K OLED
```

### Key Hardware Features

```nix
# AMD CPU tuning
services.amdcpu.enable = true;

# AMD GPU with ROCm for Ollama
services.ollama = {
  package = pkgs.ollama-vulkan;
  rocmOverrideGfx = "11.0.2";
};

# Framework laptop specific
# fw-fanctrl for fan control
services.framework16.fanctrl.enable = true;

# Touchpad
services.libinput.enable = true;

# Thunderbolt
services.hardware.bolt.enable = true;
```

### Bundles Enabled

```nix
myNixOS = {
  bundles.general-desktop.enable = true;
  bundles.developer.enable = true;
  bundles.hyprland.enable = true;
  bundles.kde.enable = false;
  bundles.gaming.enable = true;
  bundles."3d-printing".enable = true;
  
  services.amdcpu.enable = true;
  services.amdgpu.enable = true;
  multi-lang-input-layout.enable = true;
  ollama.enable = true;
  sops.enable = true;
  virt-manager.enable = true;
};
```

### Boot Configuration

```nix
boot.loader = {
  systemd-boot.enable = false;
  
  efi = {
    canTouchEfiVariables = true;
    efiSysMountPoint = "/boot";
  };
  
  grub = {
    enable = true;
    device = "nodev";
    efiSupport = true;
    useOSProber = true;
  };
};

boot.kernelPackages = pkgs.linuxPackages_latest;
zramSwap.enable = true;
```

### User Configuration

```nix
users.users.zshen = {
  isNormalUser = true;
  description = "Jason";
  extraGroups = ["networkmanager" "wheel" "audio"];
  shell = pkgs.zsh;
};
```

### Home Manager Profile

```nix
# hosts/framework-16/home.nix
{ config, pkgs, lib, inputs, ... }: {
  imports = [
    ../../modules/shared/home-manager
    ../../modules/nixos/home-manager
  ];
  
  home = {
    username = "zshen";
    homeDirectory = "/home/zshen";
    stateVersion = "24.05";
  };
  
  # Enable bundles
  myhm = {
    bundles.general.enable = true;
    bundles.office.enable = false;
    bundles.general-server.enable = false;
  };
}
```

## Zs-MacBook-Pro (nix-darwin)

### System Configuration

```nix
# hosts/mac-m1-max/configuration.nix
{ config, pkgs, lib, inputs, ... }: {
  imports = [
    ../../modules/darwin
    ./home.nix
  ];
  
  # Enable determinate nix
  services.determinate-nix.enable = true;
  
  # nix-darwin settings
  nix = {
    package = inputs.determinate.packages.darwin;
    extraOptions = "experimental-features = flakes nix-command";
    useDaemon = true;
  };
  
  # Homebrew
  homebrew = {
    enable = true;
    onActivation = {
      autoUpdate = false;
      upgrade = false;
    };
    brews = [
      # Essential tools
      "git"
      "neovim"
      "ripgrep"
      "fd"
      "fzf"
      "eza"
      "bat"
    ];
    casks = [
      "raycast"
      "alfred"
      "1password"
      "visual-studio-code"
    ];
  };
  
  # Window management
  services.yabai.enable = true;
  services.skhd.enable = true;
  services.sketchybar.enable = true;
}
```

### Home Manager Profile

```nix
# hosts/mac-m1-max/home.nix
{ config, pkgs, lib, inputs, ... }: {
  imports = [
    ../../modules/shared/home-manager
    ../../modules/darwin/home-manager
  ];
  
  home = {
    username = "zshen";
    homeDirectory = "/Users/zshen";
    stateVersion = "24.05";
  };
  
  # Enable bundles
  myhm = {
    bundles.general.enable = true;
  };
}
```

### macOS Features

```nix
# Window management
services.yabai = {
  enable = true;
  config = {
    # Tiling configuration
    layout = "bsp";
    auto_balance = true;
    mouse_follows_focus = "focus";
  };
};

# Hotkey daemon
services.skhd = {
  enable = true;
  # Custom keybindings in skhdrc
};

# Status bar
services.sketchybar = {
  enable = true;
  # Configuration in sketchybar.toml
};

# Tiling for HM
home-manager.users.zshen.services.aerospace = {
  enable = true;
  # Configuration in aerospace.toml
};
```

## Common Patterns

### Host Imports

```nix
# framework-16/configuration.nix
imports = [
  ../../modules/shared
  ../../modules/nixos
  ./hardware-configuration.nix
  ./fw-fanctrl.nix
];
```

### Dynamic Host Detection

```nix
# In modules
let
  isFramework16 = config.networking.hostName == "framework-16";
in
lib.mkIf isFramework16 {
  # Framework 16 specific config
}
```

### Conditional Bundles

```nix
# In host configuration
myNixOS = {
  bundles.hyprland.enable = pkgs.stdenv.isLinux;
  # KDE would be conditional on desktop environment
};
```

## Switch Commands

### NixOS

```bash
# Standard switch
nh os switch .

# With generation rollback
nh os switch . --switch-generation 41

# Dry run
nh os switch . --dry-run
```

### nix-darwin

```bash
# Standard switch
nh darwin switch .

# List generations
darwin-rebuild --list-generations

# Switch to specific generation
darwin-rebuild switch --switch-generation 41
```

### Home Manager

```bash
# Framework-16
home-manager switch --flake .#zshen@framework-16

# MacBook Pro
home-manager switch --flake .#zshen@Zs-MacBook-Pro
```

## Host-Specific Modules

### modules/shared/home-manager/bundles/general.nix

```nix
{ config, lib, pkgs, ... }: {
  myhm.bundles.general = {
    enable = lib.mkDefault false;
    
    programs = {
      alacritty.enable = true;
      neovim.enable = true;
      zsh.enable = true;
      starship.enable = true;
      git.enable = true;
      fzf.enable = true;
      lazygit.enable = true;
      fastfetch.enable = true;
    };
  };
}
```

### modules/nixos/bundles/gaming.nix

```nix
{ config, lib, pkgs, inputs, ... }: {
  myNixOS.bundles.gaming = {
    enable = lib.mkDefault false;
    
    nix-gaming = {
      enable = true;
      # Game-specific packages
      games = with pkgs; [
        wineWowPackages.stable
        lutris
        steam
      ];
    };
  };
}
```

## Hardware Detection

### Auto-detection

```nix
# hardware-configuration.nix is auto-generated
# But can be customized for specific hardware
```

### Manual hardware config

```nix
# For Framework laptop specific features
hardware.uinput.enable = true;
users.groups.uinput.members = ["zshen"];
users.groups.input.members = ["zshen"];
```

## Best Practices

1. **Keep host configs minimal** - Import shared modules
2. **Use bundles for feature groups** - Enable/disable easily
3. **Hardware-specific in hardware-configuration.nix** - Separate concerns
4. **Test on real hardware** - Virtual machines may miss features
5. **Document unique features** - For future reference
6. **Version stateVersion** - Match NixOS release
